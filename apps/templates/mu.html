<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Управление учётными записями </title>

    <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css">
    <!-- <link rel="stylesheet" href="/static/css/bootstrap.css"> -->
    <link rel="stylesheet" href="/static/css/bootstrap_custom.css">
    <link rel="shortcut icon" href="http://twitter.github.com/bootstrap/assets/ico/favicon.ico">

    <script src="http://yandex.st/jquery/1.8.0/jquery.min.js"></script>
    <!--<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap.js"></script> -->
    <script src="/static/js/bootstrap.js"></script>
    <script src="http://cloud.github.com/downloads/wycats/handlebars.js/handlebars-1.0.0.beta.6.js"></script>
    <script src="https://raw.github.com/nikonor/OTCLASS.js/master/otclass.js"></script>
    <script src="/static/js/umb-navigation_new.js"></script>
    
    <script id="users_tmpl" type="text/x-handlebars-template">
        {% raw %}
            <table id="table_users_list" class="table table-condensed">
                <thead>
                    <tr>
                        <th>Имя</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each items}}
                        <tr data-name={{this}}>
                            <td class='no_select_on_dbl_click'>
                                {{this}}
                            </td>
                        </tr>
                    {{/each}}
                </tbody>
            </table>
        {% endraw %}
    </script>

    <script type="text/javascript">
        $(document).ready(function(){
            var server_start_time = {{server_start_time}},
                last_sync = localStorage.getItem('yadmin_users_list_last_sync_time');
            
            // $('#filter_str').on('change', function(){
            //     filter_users();  
            // })

            $("#btn_filter_users").on('click', function(e){
                filter_users();
                e.preventDefault();
            });
            
            // Проверяем актуальность списка пользователей
            if (last_sync != server_start_time) {
                localStorage.setItem('yadmin_users_list_last_sync_time', String(server_start_time));
                console.log('last_sync', last_sync, 'server_start_time', server_start_time);
                console.log('refreshing');
                refresh_users_list()
                    .done(function(data){
                        initial_draw();
                        // demo = new OTCLASS({
                        //   'id':'users_list',
                        //   'data':tmp_data,
                        //   'div_id': 'container',
                        //   'tmpl_id': 'tmpl',
                        //   'sort':'age',
                        //   'debug':1
                        // });
                    });
            } else {
                initial_draw();
            }
            
            // Вешаем событие на нажатия кнопок.
            $(document).on('click', 'div.btn-group button:even', function(){
                $('div.btn-group button.btn-primary').removeClass('btn-primary');
                $(this).addClass('btn-primary').next().addClass('btn-primary');
                // console.log($(this), 'was clicked');
                localStorage.setItem('current_domain', $(this).data('domain'));
                draw_users(convert_users_to_list(JSON.parse(localStorage.getItem('yadmin_users_'+$(this).data('domain')))));
            })

        }) // document.ready

        function initial_draw(){
            console.log('initial_draw');
            var first_button = $('div.btn-toolbar').find('div.btn-group').eq(0).find('button').eq(0);
            first_button.addClass('btn-primary').next().addClass('btn-primary');
            draw_users(convert_users_to_list(JSON.parse(localStorage.getItem('yadmin_users_'+first_button.data('domain')))));
            localStorage.setItem('current_domain', first_button.data('domain'));
        }

        function draw_users(users){
            // Обновляем таблицу
            var users_template = Handlebars.compile($('#users_tmpl').html());
            $("#users_table").empty().append(users_template({items: users}));
        }

        function filter_users(){
            var search_str = $("#filter_str").val(),
                users = JSON.parse(localStorage.getItem('yadmin_users_'+localStorage.getItem('current_domain'))),
                tmp = convert_users_to_list(users);

            var res = $.grep(tmp, function(elem){
                return elem.indexOf(search_str)+1;
            })
            console.log(res);
            draw_users(res);
        }

        function convert_users_to_list(users){
            var tmp=[];
            for (var i in users){
                tmp.push(users[i]['name']);
            }
            return tmp
        }

        function refresh_users_list(){
            return $.getJSON('/mu', {do_what: 'refresh_users_list'}).done(function(data){
                if (data.success){
                    $.each(data.items, function(key, val){
                        localStorage.setItem('yadmin_users_'+key, JSON.stringify(val));    
                    })
                    console.log('Список пользователей обновлён');
                    $(document).trigger('users_list_freshness_ok');
                } 
            });
        }
    </script>
</head>

<body>
    <div class='container'>
        <div class="navbar">
            <div class="navbar-inner">
                <div class='btn-toolbar'>
                    {% for i in domains %}
                        <div class="btn-group">
                            <button class="btn" data-domain="{{ i }}" data-do_what="list_users"> {{ i }}
                                <button class="btn dropdown-toggle" data-toggle="dropdown">
                                    <span class="caret"></span>
                                </button>
                                <ul class='dropdown-menu'>
                                    <li><a href="#">Настройки домена</a></li>
                                </ul>
                            </li>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- <div class="tab-content"> -->
        <form class="form-search">
          <div class="input-append">
            <input type="text" placeholder="Имя" id="filter_str" class="search-query" autocomplete="off">
            <button id="btn_filter_users" class="btn">Отбор</button>
          </div>
        </form>
        
        <div id='users_table'>
            
        </div>
        
        <!-- </div> -->
        <div class="container-fluid">
            <span class='span4 offset4'id="dp_nav"></span>
        </div>
    </div>
    
</body>
</html>